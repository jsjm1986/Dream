class DreamAPI {
    constructor() {
        this.apiKey = ''; // Deepseek API密钥
        this.baseUrl = 'https://api.deepseek.com/v1';
    }

    setApiKey(key) {
        this.apiKey = key;
    }

    async interpretDream(dreamDescription) {
        const prompt = `作为一位资深的梦境分析专家和心理分析师，请运用多维度的心理学理论和方法，对以下梦境进行全方位的专业解析。整合使用以下理论体系：

1. 精神分析学派：
   - 弗洛伊德的本我-自我-超我结构
   - 潜意识冲动与防御机制
   - 童年经验与性心理发展阶段
   - 愿望满足理论

2. 分析心理学派：
   - 荣格的个人无意识与集体无意识
   - 原型理论（阿尼玛/阿尼姆斯、阴影、自性等）
   - 个性化过程
   - 象征与转化

3. 存在主义心理学：
   - 生命意义的探索
   - 存在焦虑与自由
   - 真实自我的觉察
   - 当下体验的重要性

4. 格式塔心理学：
   - 整体性知觉
   - 图形-背景关系
   - 完形闭合

梦境内容：
${dreamDescription}

请按照以下框架进行深入分析：

1. 梦境结构解析：
   - 表层叙事脉络梳理
   - 深层象征结构分析
   - 时空转换的意义
   - 情节发展的内在逻辑

2. 核心意象分析：
   - 主要象征物的多层含义
   - 人物原型的识别与解读
   - 场景的心理空间意义
   - 色彩、数字等元素的象征

3. 心理动力分析：
   - 意识与无意识的互动
   - 心理冲突的表现形式
   - 防御机制的运作方式
   - 潜在的心理需求

4. 原型与集体无意识探索：
   - 普遍人性主题的体现
   - 文化原型的显现
   - 神话元素的对应
   - 集体记忆的映射

5. 个人心理图景：
   - 当前心理状态评估
   - 人格特质的反映
   - 内在资源的识别
   - 成长潜能的展现

6. 现实生活关联：
   - 近期生活事件的投射
   - 人际关系的反映
   - 职业发展的暗示
   - 生活态度的体现

7. 心理治疗视角：
   - 创伤经验的处理
   - 心理健康的指标
   - 适应功能的评估
   - 心理资源的激活

8. 整合性建议：
   A. 自我觉察层面：
      - 意识拓展的方向
      - 盲点的识别
      - 自我认知的深化
   
   B. 个人成长层面：
      - 心理能量的疏导
      - 人格整合的路径
      - 潜能开发的方向
   
   C. 行动建议：
      - 具体可行的步骤
      - 生活方式的调整
      - 人际互动的优化
      - 自我照顾的方法

请用专业而富有洞察力的语言进行分析，在保持专业深度的同时确保表达清晰易懂。注重理论与实践的结合，为来访者提供既有深度又有实用价值的解读。在分析中要特别注意梦境中的情感基调和能量流动，以及它们与个人成长的关联。`;

        try {
            const response = await this.callAPI(prompt);
            return response;
        } catch (error) {
            console.error('梦境解读出错:', error);
            throw new Error('无法完成梦境解读，请稍后再试');
        }
    }

    async continueDream(dreamFragment) {
        const prompt = `作为一位融合心理分析、叙事学和文学创作的梦境续写专家，请基于以下理论框架，对梦境片段进行深度创造性续写：

1. 心理分析理论基础：
   A. 弗洛伊德梦的理论：
      - 日残余物的整合
      - 愿望满足机制
      - 压抑内容的象征性表达
      - 凝缩与移置的运用
   
   B. 荣格原型理论：
      - 集体无意识的显现
      - 原型意象的自然延展
      - 个性化过程的体现
      - 象征转化的过程

2. 叙事学理论支持：
   A. 结构主义叙事：
      - 时序编排（线性/非线性）
      - 视角转换技巧
      - 叙事层次的构建
      - 情节单元的组织
   
   B. 后现代叙事：
      - 现实与虚幻的交织
      - 多重时空的并置
      - 意识流的运用
      - 碎片化与整合

3. 文学创作技法：
   A. 意象系统：
      - 核心意象的延展
      - 意象群的构建
      - 象征系统的编织
      - 隐喻链的形成
   
   B. 氛围营造：
      - 感官描写的层次
      - 情绪基调的控制
      - 节奏的张弛变化
      - 空间氛围的渲染

梦境片段：
${dreamFragment}

请按照以下框架进行艺术性续写：

1. 梦境空间构建：
   A. 物理空间：
      - 场景的流动性转换
      - 空间的延展与收缩
      - 边界的模糊与重构
      - 几何结构的象征
   
   B. 心理空间：
      - 情感场的营造
      - 意识层次的转换
      - 心理距离的调节
      - 潜意识空间的展开

2. 叙事结构设计：
   A. 时间维度：
      - 时间流动的特殊性
      - 记忆与预见的交织
      - 循环与断裂的运用
      - 时间密度的变化
   
   B. 情节发展：
      - 内在逻辑的延展
      - 转折点的设置
      - 矛盾冲突的深化
      - 高潮的酝酿与释放

3. 意象系统构建：
   A. 核心意象：
      - 原型意象的延伸
      - 个人象征的深化
      - 文化符号的融入
      - 意象的转化与重组
   
   B. 细节描写：
      - 感官细节的铺陈
      - 微观世界的展现
      - 象征性细节的点缀
      - 暗示性细节的布置

4. 心理层面的展开：
   A. 情感流动：
      - 基础情绪的变化
      - 复杂情感的交织
      - 潜意识情感的涌动
      - 情感能量的流转
   
   B. 意识活动：
      - 思维图景的展现
      - 潜意识的自然流露
      - 直觉认知的呈现
      - 顿悟时刻的设计

5. 艺术效果的追求：
   A. 语言风格：
      - 意象性语言的运用
      - 节奏感的把控
      - 音乐性的追求
      - 诗性表达的融入
   
   B. 整体效果：
      - 梦境真实感的营造
      - 深层意义的暗示
      - 艺术张力的形成
      - 启发性的植入

请以优美而富有画面感的语言进行续写，在保持梦境特有的非理性逻辑的同时，注意故事的内在连贯性。要让续写的内容既符合梦的特质，又蕴含深层的心理意义，同时具有文学艺术价值。特别注意情感能量的流动和象征意义的自然呈现，让整个梦境故事既神秘深邃，又富有启发性和治愈性。`;

        try {
            const response = await this.callAPI(prompt);
            return response;
        } catch (error) {
            console.error('梦境续写出错:', error);
            throw new Error('无法完成梦境续写，请稍后再试');
        }
    }

    async callAPI(prompt) {
        if (!this.apiKey) {
            throw new Error('请先设置API密钥');
        }

        try {
            const response = await fetch(`${this.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.apiKey}`
                },
                body: JSON.stringify({
                    model: 'deepseek-chat',
                    messages: [
                        {
                            role: 'user',
                            content: prompt
                        }
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                throw new Error(`API请求失败: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        } catch (error) {
            console.error('API调用出错:', error);
            throw error;
        }
    }
}

// 导出API实例
window.dreamAPI = new DreamAPI(); 